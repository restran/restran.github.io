<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>




  <meta name="author" content="restran" />





  <link rel="alternate" href="/atom.xml" title="淡水网志" type="application/atom+xml" />



  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta name="description" content="在 CentOS 6.5 Minimal 系统环境下，用源代码的方式安装 Gitlab 7.5 的过程中，遇到了不少问题，现把笔记整理出来。 Distribution      : CentOS 6.5 Minimal GitLab version    : 7.0 - 7.4 Web Server        : Apache, Nginx Init system       : sysvin">
<meta name="keywords" content="gitlab,git,源码安装,centos,社区版,部署,维护,指南">
<meta property="og:type" content="article">
<meta property="og:title" content="CentOS 6.5 环境下 Gitlab 7.5 安装和维护笔记">
<meta property="og:url" content="http://www.restran.net/2015/04/09/gilab-centos-installation-note/index.html">
<meta property="og:site_name" content="淡水网志">
<meta property="og:description" content="在 CentOS 6.5 Minimal 系统环境下，用源代码的方式安装 Gitlab 7.5 的过程中，遇到了不少问题，现把笔记整理出来。 Distribution      : CentOS 6.5 Minimal GitLab version    : 7.0 - 7.4 Web Server        : Apache, Nginx Init system       : sysvin">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-05-01T07:31:45.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CentOS 6.5 环境下 Gitlab 7.5 安装和维护笔记">
<meta name="twitter:description" content="在 CentOS 6.5 Minimal 系统环境下，用源代码的方式安装 Gitlab 7.5 的过程中，遇到了不少问题，现把笔记整理出来。 Distribution      : CentOS 6.5 Minimal GitLab version    : 7.0 - 7.4 Web Server        : Apache, Nginx Init system       : sysvin">

<script src="/vendors/pace/pace.min.js"></script>
<link href="/vendors/pace/themes/red/pace-theme-minimal.css" rel="stylesheet" />


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: ''
  };
</script>



  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-38277310-2', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?a060ea3ffa16e451223f396f226de9c7";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <title> CentOS 6.5 环境下 Gitlab 7.5 安装和维护笔记 | 淡水网志 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->

  
    
  

  <div class="container one-column page-post-detail">
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner "><h1 class="site-meta">
  <!-- <span class="logo-line-before"><i></i></span> -->
  <a href="/" class="brand" rel="start">
      <span class="logo" style="background-image:url(/uploads/avatar.jpg)">
      </span>
      <span class="site-title">淡水网志</span>
  </a>
  <!-- <span class="logo-line-after"><i></i></span> -->
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-next-categories"></i> <br />
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-portfolio">
          <a href="/portfolio" rel="section">
            <i class="menu-item-icon icon-next-portfolio"></i> <br />
            作品集
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            <i class="menu-item-icon icon-next-about"></i> <br />
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      
  


      <div class="main-inner">

        <div id="content" class="content ">
          

  <div id="posts" class="posts-expand">
   
    
  
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              CentOS 6.5 环境下 Gitlab 7.5 安装和维护笔记
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
         <!--  发表于 -->
          <time itemprop="dateCreated" datetime="2015-04-09T00:00:00+08:00" content="2015-04-09">
            2015-04-09
          </time>
        </span>

        <span class="post-content-count">&nbsp; | &nbsp; 5,514字</span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/Git/" itemprop="url" rel="index">
                  <span itemprop="name">Git</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          &nbsp; | &nbsp;
          <span id="/2015/04/09/gilab-centos-installation-note/"class="leancloud_visitors" data-flag-title="CentOS 6.5 环境下 Gitlab 7.5 安装和维护笔记">
                   &nbsp;阅读
                  </span>
        
        
        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/04/09/gilab-centos-installation-note/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/04/09/gilab-centos-installation-note/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><p>在 CentOS 6.5 Minimal 系统环境下，用源代码的方式安装 Gitlab 7.5 的过程中，遇到了不少问题，现把笔记整理出来。</p>
<pre><code>Distribution      : CentOS 6.5 Minimal
GitLab version    : 7.0 - 7.4
Web Server        : Apache, Nginx
Init system       : sysvinit
Database          : MySQL, PostgreSQL
Contributors      : @nielsbasjes, @axilleas, @mairin, @ponsjuh, @yorn, @psftw, @etcet, @mdirkse, @nszceta, @herkalurk
Additional Notes  : In order to get a proper Ruby setup we build it from source
</code></pre><h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>Please read <a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/install/requirements.md" target="_blank" rel="noopener">requirements.md</a> for hardware and platform requirements.</p>
<h3 id="Important-Notes"><a href="#Important-Notes" class="headerlink" title="Important Notes"></a>Important Notes</h3><p>The following steps have been known to work and should be followed from up to bottom.<br>If you deviate from this guide, do it with caution and make sure you don’t violate<br>any assumptions GitLab makes about its environment. We have also tried this on<br>RHEL 6.3 and found that there are subtle differences which are documented in part.<br>Look for the <strong>RHEL Notes</strong> note.</p>
<p><strong>全部命令都是在 root 用户下执行</strong></p>
<h4 id="If-you-find-a-bug"><a href="#If-you-find-a-bug" class="headerlink" title="If you find a bug"></a>If you find a bug</h4><p>If you find a bug/error in this guide please submit an issue or a Merge Request<br>following the contribution guide (see <a href="https://gitlab.com/gitlab-org/gitlab-recipes/blob/master/CONTRIBUTING.md" target="_blank" rel="noopener">CONTRIBUTING.md</a>).</p>
<h4 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h4><p>Many setup guides of Linux software simply state: “disable selinux and firewall”.<br>This guide does not disable any of them, we simply configure them as they were intended.<br><a href="http://stopdisablingselinux.com/" target="_blank" rel="noopener">Stop disabling SELinux</a>.</p>
<hr>
<p>The GitLab installation consists of setting up the following components:</p>
<ol>
<li>Install the base operating system (CentOS 6.5 Minimal) and Packages / Dependencies</li>
<li>Ruby</li>
<li>System Users</li>
<li>Database</li>
<li>Redis</li>
<li>GitLab</li>
<li>Web server</li>
<li>Firewall</li>
</ol>
<hr>
<h2 id="1-Installing-the-operating-system-CentOS-6-5-Minimal"><a href="#1-Installing-the-operating-system-CentOS-6-5-Minimal" class="headerlink" title="1. Installing the operating system (CentOS 6.5 Minimal)"></a>1. Installing the operating system (CentOS 6.5 Minimal)</h2><p>We start with a completely clean CentOS 6.5 “minimal” installation which can be<br>accomplished by downloading the appropriate installation iso file. Just boot the<br>system of the iso file and install the system.</p>
<p><strong>配置网络</strong></p>
<p>Note that during the installation you use the <em>“Configure Network”</em> option (it’s a<br>button in the same screen where you specify the hostname) to enable the <em>“Connect automatically”</em><br>option for the network interface and hand (usually eth0).</p>
<p><strong>If you forget this option the network will NOT start at boot.</strong></p>
<p>The end result is a bare minimum CentOS installation that effectively only has<br>network connectivity and (almost) no services at all.</p>
<h2 id="Updating-and-adding-basic-software-and-services"><a href="#Updating-and-adding-basic-software-and-services" class="headerlink" title="Updating and adding basic software and services"></a>Updating and adding basic software and services</h2><h3 id="Add-EPEL-repository"><a href="#Add-EPEL-repository" class="headerlink" title="Add EPEL repository"></a>Add EPEL repository</h3><p><strong>安装 wget</strong></p>
<pre><code>yum -y install wget
</code></pre><p><a href="https://fedoraproject.org/wiki/EPEL" target="_blank" rel="noopener">EPEL</a> is a volunteer-based community effort from the Fedora project to create<br>a repository of high-quality add-on packages that complement the Fedora-based<br>Red Hat Enterprise Linux (RHEL) and its compatible spinoffs, such as CentOS and Scientific Linux.</p>
<p>As part of the Fedora packaging community, EPEL packages are 100% free/libre open source software (FLOSS).</p>
<p>Download the GPG key for EPEL repository from <a href="https://fedoraproject.org/keys" target="_blank" rel="noopener">fedoraproject</a> and install it on your system:</p>
<pre><code>wget -O /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6 https://www.fedoraproject.org/static/0608B895.txt --no-check-certificate
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6
</code></pre><p>Verify that the key got installed successfully:</p>
<pre><code>rpm -qa gpg*
结果应显示
gpg-pubkey-0608b895-4bd22942
</code></pre><p>Now install the <code>epel-release-6-8.noarch</code> package, which will enable EPEL repository on your system:</p>
<pre><code>rpm -Uvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
</code></pre><p><strong>Note:</strong> Don’t mind the <code>x86_64</code>, if you install on a i686 system you can use the same commands.</p>
<h3 id="Add-PUIAS-Computational-repository"><a href="#Add-PUIAS-Computational-repository" class="headerlink" title="Add PUIAS Computational repository"></a>Add PUIAS Computational repository</h3><p>The <a href="https://puias.math.ias.edu/wiki/YumRepositories6#Computational" target="_blank" rel="noopener">PUIAS Computational</a> repository is a part of <a href="https://puias.math.ias.edu" target="_blank" rel="noopener">PUIAS/Springdale Linux</a>,<br>a custom Red Hat&reg; distribution maintained by <a href="http://www.princeton.edu/" target="_blank" rel="noopener">Princeton University</a> and the<br><a href="http://www.ias.edu/" target="_blank" rel="noopener">Institute for Advanced Study</a>.  We take advantage of the PUIAS<br>Computational repository to obtain a git v1.8.x package since the base CentOS<br>repositories only provide v1.7.1 which is not compatible with GitLab.<br>Although the PUIAS offers an RPM to install the repo, it requires the<br>other PUIAS repos as a dependency, so you’ll have to add it manually.<br>Otherwise you can install git from source (instructions below).</p>
<p>Download PUIAS repo:</p>
<pre><code>wget -O /etc/yum.repos.d/PUIAS_6_computational.repo https://gitlab.com/gitlab-org/gitlab-recipes/raw/master/install/centos/PUIAS_6_computational.repo --no-check-certificate
</code></pre><p>Next download and install the gpg key:</p>
<pre><code>wget -O /etc/pki/rpm-gpg/RPM-GPG-KEY-puias http://springdale.math.ias.edu/data/puias/6/x86_64/os/RPM-GPG-KEY-puias
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-puias
</code></pre><p>Verify that the key got installed successfully:</p>
<pre><code>rpm -qa gpg*
结果应显示
gpg-pubkey-41a40948-4ce19266
</code></pre><p>Verify that the EPEL and PUIAS Computational repositories are enabled as shown below:</p>
<pre><code>yum repolist
</code></pre><p>如果出现错误 Error: Cannot retrieve metalink for repository: epel. Please verify its path and try again</p>
<pre><code>vim /etc/yum.repos.d/epel.repo，把基础的恢复，镜像的地址注释掉

#baseurl
mirrorlist
</code></pre><p>改成</p>
<pre><code>baseurl
#mirrorlist

repo id                 repo name                                                status
PUIAS_6_computational   PUIAS computational Base 6 - x86_64                      2,018
base                    CentOS-6 - Base                                          4,802
epel                    Extra Packages for Enterprise Linux 6 - x86_64           7,879
extras                  CentOS-6 - Extras                                           12
updates                 CentOS-6 - Updates                                         814
repolist: 15,525
</code></pre><p>If you can’t see them listed, use the folowing command (from <code>yum-utils</code> package) to enable them:</p>
<pre><code>先安装yum-utils，才能使用yum-config-manager，否则会出现commond not found
yum -y install yum-utils

yum-config-manager --enable epel --enable PUIAS_6_computational
</code></pre><h3 id="Install-the-required-tools-for-GitLab"><a href="#Install-the-required-tools-for-GitLab" class="headerlink" title="Install the required tools for GitLab"></a>Install the required tools for GitLab</h3><pre><code>yum -y update
yum -y groupinstall &apos;Development Tools&apos;
yum -y install readline readline-devel ncurses-devel gdbm-devel glibc-devel tcl-devel openssl-devel curl-devel expat-devel db4-devel byacc sqlite-devel libyaml libyaml-devel libffi libffi-devel libxml2 libxml2-devel libxslt libxslt-devel libicu libicu-devel system-config-firewall-tui redis sudo wget crontabs logwatch logrotate perl-Time-HiRes git cmake libcom_err-devel.i686 libcom_err-devel.x86_64
</code></pre><p><strong>RHEL Notes</strong></p>
<p>If some packages (eg. gdbm-devel, libffi-devel and libicu-devel) are NOT installed,<br>add the rhel6 optional packages repo to your server to get those packages:</p>
<pre><code>yum-config-manager --enable rhel-6-server-optional-rpms
</code></pre><p>Tip taken from <a href="https://github.com/gitlabhq/gitlab-recipes/issues/62" target="_blank" rel="noopener">here</a>.</p>
<p><strong>Note:</strong><br>During this installation some files will need to be edited manually.<br>If you are familiar with vim set it as default editor with the commands below.<br>If you are not familiar with vim please skip this and keep using the default editor.</p>
<pre><code># Install vim and set as default editor
yum -y install vim-enhanced
update-alternatives --set editor /usr/bin/vim.basic

# For reStructuredText markup language support, install required package:
yum -y install python-docutils
</code></pre><h3 id="Install-mail-server"><a href="#Install-mail-server" class="headerlink" title="Install mail server"></a>Install mail server</h3><p>In order to receive mail notifications, make sure to install a<br>mail server. The recommended one is postfix and you can install it with:</p>
<pre><code>yum -y install postfix
</code></pre><p>To use and configure sendmail instead of postfix see <a href="e-mail/configure_email.md">Advanced Email Configurations</a>.</p>
<h3 id="Configure-the-default-editor"><a href="#Configure-the-default-editor" class="headerlink" title="Configure the default editor"></a>Configure the default editor</h3><p>You can choose between editors such as nano, vi, vim, etc.<br>In this case we will use vim as the default editor for consistency.</p>
<pre><code>ln -s /usr/bin/vim /usr/bin/editor
</code></pre><p>To remove this alias in the future:<br>以后删除别名的时候用这条命令</p>
<pre><code>rm -i /usr/bin/editor
</code></pre><h3 id="Install-Git-from-Source-optional"><a href="#Install-Git-from-Source-optional" class="headerlink" title="Install Git from Source (optional)"></a>Install Git from Source (optional)</h3><p>Make sure Git is version 1.7.10 or higher, for example 1.7.12 or 1.8.4</p>
<pre><code>git --version
</code></pre><p>如果有安装git，这一步就可以跳过，直接跳到Ruby</p>
<p>If not, install it from source. First remove the system Git:</p>
<pre><code>yum -y remove git
</code></pre><p>Install the pre-requisite files for Git compilation:</p>
<pre><code>yum install zlib-devel perl-CPAN gettext curl-devel expat-devel gettext-devel openssl-devel
</code></pre><p>Download and extract it:</p>
<pre><code>mkdir /tmp/git &amp;&amp; cd /tmp/git
curl --progress https://www.kernel.org/pub/software/scm/git/git-2.1.3.tar.gz | tar xz
cd git-2.1.3/
./configure
make
make prefix=/usr/local install
</code></pre><p>Make sure Git is in your <code>$PATH</code>:</p>
<pre><code>which git
</code></pre><p>You might have to logout and login again for the <code>$PATH</code> to take effect.<br><strong>Note:</strong> When editing <code>config/gitlab.yml</code> (step 6), change the git <code>bin_path</code> to <code>/usr/local/bin/git</code>.</p>
<hr>
<h2 id="2-Ruby"><a href="#2-Ruby" class="headerlink" title="2. Ruby"></a>2. Ruby</h2><p>The use of ruby version managers such as <a href="http://rvm.io/" target="_blank" rel="noopener">RVM</a>, <a href="https://github.com/sstephenson/rbenv" target="_blank" rel="noopener">rbenv</a> or <a href="https://github.com/postmodern/chruby" target="_blank" rel="noopener">chruby</a> with GitLab in production frequently leads to hard to diagnose problems. Version managers are not supported and we strongly advise everyone to follow the instructions below to use a system ruby.</p>
<p>Remove the old Ruby 1.8 package if present. GitLab only supports the Ruby 2.0+ release series:</p>
<pre><code>yum remove ruby
</code></pre><p>Remove any other Ruby build if it is still present:</p>
<pre><code>cd &lt;your-ruby-source-path&gt;
make uninstall
</code></pre><p>如果没有安装ruby，上述删除的步骤可以跳过</p>
<p>Download Ruby and compile it:</p>
<pre><code>mkdir /tmp/ruby &amp;&amp; cd /tmp/ruby
curl --progress ftp://ftp.ruby-lang.org/pub/ruby/2.1/ruby-2.1.2.tar.gz | tar xz

cd ruby-2.1.2
./configure --disable-install-rdoc
</code></pre><p>如果出现错误<br>    make: Warning: File ‘common.mk’ has modification time 1386501635 s in the future<br>    是由于系统的时间错误导致</p>
<p>一、修正时区</p>
<pre><code>rm -rf /etc/localtime    # 删除当前默认时区www.kwx.gd
ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime 
# 复制替换默认时区为上海
SSH执行以上命令，将时区修改为中国上海的时区，当然，也可以设置中国香港或北京的时间。
</code></pre><p> 二、手动修正时间</p>
<pre><code>date -s &apos;09:16:00 2013-01-21&apos; 
</code></pre><p>使用“date”命令，修改时间和日期为2013年1月21日，时间是上午9点16分0秒。</p>
<p>三、时间自动同步和校正</p>
<pre><code>yum install -y ntp        #安装时间同步服务（组件）
ntpdate us.pool.ntp.org   #设置同步服务器
date                      #查看当前时间www.kwx.gd
</code></pre><p>部分系统已经安装了NTP服务，系统会根据当前记录的时区（第一步操作）自动连接ntp服务器校正时间。</p>
<pre><code>make
make prefix=/usr/local install
</code></pre><p>Install the Bundler Gem:</p>
<p>由于AWS被墙无法使用，修改ruby的源</p>
<pre><code>gem sources --remove https://rubygems.org/
gem sources -a https://ruby.taobao.org/
gem sources -l

gem install bundler --no-doc
</code></pre><p>Logout and login again for the <code>$PATH</code> to take effect. Check that ruby is properly<br>installed with:</p>
<pre><code>which ruby
# /usr/local/bin/ruby
ruby -v
# ruby 2.1.2p95 (2014-05-08 revision 45877) [x86_64-linux]
</code></pre><hr>
<h2 id="3-System-Users"><a href="#3-System-Users" class="headerlink" title="3. System Users"></a>3. System Users</h2><p>Create a <code>git</code> user for Gitlab:</p>
<pre><code>adduser --system --shell /bin/bash --comment &apos;GitLab&apos; --create-home --home-dir /home/git/ git
</code></pre><p><strong>Important:</strong> In order to include <code>/usr/local/bin</code> to git user’s PATH, one way is to edit the sudoers file. As root run:</p>
<pre><code>visudo
</code></pre><p>Then search for this line:</p>
<pre><code>Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin
</code></pre><p>and append <code>/usr/local/bin</code> like so:</p>
<pre><code>Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin
</code></pre><p>Save and exit.</p>
<hr>
<h2 id="4-Database"><a href="#4-Database" class="headerlink" title="4. Database"></a>4. Database</h2><h3 id="4-2-MySQL"><a href="#4-2-MySQL" class="headerlink" title="4.2 MySQL"></a>4.2 MySQL</h3><p>Install <code>mysql</code> and enable the <code>mysqld</code> service to start on boot:</p>
<pre><code>使用这条命令默认安装的是5.1.37版本
yum install -y mysql-server mysql-devel

使用这些命令安装5.5.41版本
rpm -Uvh http://dl.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm
rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-6.rpm
yum --enablerepo=remi,remi-test install mysql mysql-server mysql-devel


chkconfig mysqld on
service mysqld start
</code></pre><p>Ensure you have MySQL version 5.5.14 or later:</p>
<pre><code>mysql --version
</code></pre><p>Secure your installation:</p>
<pre><code>mysql_secure_installation
</code></pre><p>Login to MySQL (type the database root password):</p>
<pre><code>mysql -u root -p
</code></pre><p>Create a user for GitLab (change $password in the command below to a real password you pick):</p>
<p><strong>修改$password为自己的密码</strong></p>
<pre><code>CREATE USER &apos;git&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;$password&apos;;
</code></pre><p>Ensure you can use the InnoDB engine which is necessary to support long indexes.<br>If this fails, check your MySQL config files (e.g. <code>/etc/mysql/*.cnf</code>, <code>/etc/mysql/conf.d/*</code>) for the setting “innodb = off”.</p>
<pre><code>SET storage_engine=INNODB;
</code></pre><p>Create the GitLab production database:</p>
<pre><code>CREATE DATABASE IF NOT EXISTS `gitlabhq_production` DEFAULT CHARACTER SET `utf8` COLLATE `utf8_unicode_ci`;
</code></pre><p>Grant the GitLab user necessary permissions on the table:</p>
<pre><code>GRANT SELECT, LOCK TABLES, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON `gitlabhq_production`.* TO &apos;git&apos;@&apos;localhost&apos;;
</code></pre><p>Quit the database session:</p>
<pre><code>\q
</code></pre><p>Try connecting to the new database with the new user:</p>
<pre><code>sudo -u git -H mysql -u git -p -D gitlabhq_production
</code></pre><p>使用上面在MySQL中创建的git用户的密码</p>
<p>Quit the database session:</p>
<pre><code>\q
</code></pre><p>配置MySQL max_allowed_packet的大小，避免POST太大的内容导致出现500错误，例如GitLab 发出MergeRequest的时候返回500错误。</p>
<pre><code>vim /etc/my.cnf
</code></pre><p>在mysqld中添加max_allowed_packet，调整值，加大为一个合适的数字即可。</p>
<pre><code>[mysqld]
max_allowed_packet=512M
</code></pre><p>然后reload下mysql的服务即可。</p>
<pre><code>service mysqld restart
</code></pre><hr>
<h2 id="5-Redis"><a href="#5-Redis" class="headerlink" title="5. Redis"></a>5. Redis</h2><p>Make sure redis is started on boot:</p>
<pre><code>chkconfig redis on
</code></pre><p>Configure redis to use sockets:</p>
<pre><code>cp /etc/redis.conf /etc/redis.conf.orig
</code></pre><p>Disable Redis listening on TCP by setting ‘port’ to 0:</p>
<pre><code>sed &apos;s/^port .*/port 0/&apos; /etc/redis.conf.orig | sudo tee /etc/redis.conf
</code></pre><p>Enable Redis socket for default CentOS path:</p>
<pre><code>echo &apos;unixsocket /var/run/redis/redis.sock&apos; | sudo tee -a /etc/redis.conf
echo -e &apos;unixsocketperm 0775&apos; | sudo tee -a /etc/redis.conf
</code></pre><p>Activate the changes to redis.conf:</p>
<pre><code>service redis restart
</code></pre><p>Add git to the redis group:</p>
<pre><code>usermod -aG redis git
</code></pre><hr>
<h2 id="6-GitLab"><a href="#6-GitLab" class="headerlink" title="6. GitLab"></a>6. GitLab</h2><pre><code># We&apos;ll install GitLab into home directory of the user &quot;git&quot;
cd /home/git
</code></pre><h3 id="Clone-the-Source"><a href="#Clone-the-Source" class="headerlink" title="Clone the Source"></a>Clone the Source</h3><p>   // vi /home/git/.bash_profile<br>   // 添加如下，不验证SSL<br>   // export GIT_SSL_NO_VERIFY=1</p>
<pre><code>否则 git clone 时会出现错误 Peer certificate cannot be authenticated with known CA certificates

# Clone GitLab repository
sudo -u git -H git clone https://gitlab.com/gitlab-org/gitlab-ce.git -b 7-4-stable gitlab
</code></pre><p><strong>Gitlab 中文翻译版</strong></p>
<p>不知道为什么，使用sudo -u git -H git clone..还会出现证书错误，但是使用下面的就可以<br>    su - git<br>    先进入git用户，然后git config，才可以，不然还是会出现证书问题<br>    git config –global http.sslverify “false”</p>
<pre><code>git clone https://gitlab.com/larryli/gitlab.git -b 7-5-zh gitlab

# 自己的修改版，修改部分翻译
git clone https://github.com/restran/gitlabhq.git -b 7-5-zh gitlab

退出git用户操作命令，使用root用户操作
logout
</code></pre><p><strong>Note:</strong> You can change <code>7-4-stable</code> to <code>master</code> if you want the <em>bleeding edge</em> version, but do so with caution!</p>
<h3 id="Configure-it"><a href="#Configure-it" class="headerlink" title="Configure it"></a>Configure it</h3><pre><code># Go to GitLab installation folder
cd /home/git/gitlab
</code></pre><p>为了方便添加git用户拥有root权限 [sudoers文件默认没有写权限需要强制保存:wq!]<br>使用root用户执行下述命令</p>
<pre><code>vi /etc/sudoers
</code></pre><p>最后添加</p>
<pre><code>git     ALL=(ALL)       ALL
</code></pre><p>Copy the example GitLab config</p>
<pre><code>sudo -u git -H cp config/gitlab.yml.example config/gitlab.yml
</code></pre><p>Update GitLab config file, follow the directions at top of file</p>
<pre><code>sudo -u git -H editor config/gitlab.yml
</code></pre><p>配置 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">host: 192.168.137.142</span><br><span class="line">port: 8008</span><br><span class="line">email_from: gitlab@example.com</span><br><span class="line">email_enabled: false</span><br><span class="line">default_theme: 1</span><br></pre></td></tr></table></figure>
<p>Make sure GitLab can write to the log/ and tmp/ directories</p>
<pre><code>chown -R git log/
chown -R git tmp/
chmod -R u+rwX log/
chmod -R u+rwX tmp/
</code></pre><p>Create directory for satellites</p>
<pre><code>sudo -u git -H mkdir /home/git/gitlab-satellites
chmod u+rwx,g=rx,o-rwx /home/git/gitlab-satellites
</code></pre><p>Make sure GitLab can write to the tmp/pids/ and tmp/sockets/ directories</p>
<pre><code>chmod -R u+rwX tmp/pids/
chmod -R u+rwX tmp/sockets/
</code></pre><p>Make sure GitLab can write to the public/uploads/ directory</p>
<pre><code>chmod -R u+rwX  /home/git/gitlab/public/uploads
</code></pre><p>Copy the example Unicorn config</p>
<pre><code>sudo -u git -H cp config/unicorn.rb.example config/unicorn.rb
</code></pre><p>查看CPU的核心数量</p>
<pre><code>nproc

# Enable cluster mode if you expect to have a high load instance
# Ex. change amount of workers to 3 for 2GB RAM server
# Set the number of workers to at least the number of cores
sudo -u git -H editor config/unicorn.rb
</code></pre><p><strong>特别注意：比较差配置的机器，注意将unicorn.rb中的timeout设置大一点，因为第一次启动的时候Gitlab需要初始化，如果timeout太小，由于需要执行较长时间，导致无法正常启动，出现502错误</strong></p>
<pre><code># Copy the example Rack attack config
sudo -u git -H cp config/initializers/rack_attack.rb.example config/initializers/rack_attack.rb
</code></pre><p>Configure Git global settings for git user, useful when editing via web. Edit user.email according to what is set in gitlab.yml</p>
<pre><code>sudo -u git -H git config --global user.name &quot;GitLab&quot;
sudo -u git -H git config --global user.email &quot;gitlab@example.com&quot;
sudo -u git -H git config --global core.autocrlf input
</code></pre><p>Configure Redis connection settings</p>
<pre><code>sudo -u git -H cp config/resque.yml.example config/resque.yml
</code></pre><p>如果不使用默认的端口，则需要配置，Change the Redis socket path if you are not using the default CentOS configuration</p>
<pre><code>sudo -u git -H editor config/resque.yml
</code></pre><p><strong>Important Note:</strong> Make sure to edit both <code>gitlab.yml</code> and <code>unicorn.rb</code> to match your setup.</p>
<p><strong>Note:</strong> If you want to use HTTPS, see <a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/install/installation.md#using-https" target="_blank" rel="noopener">Using HTTPS</a> for the additional steps.</p>
<h3 id="Configure-GitLab-DB-settings"><a href="#Configure-GitLab-DB-settings" class="headerlink" title="Configure GitLab DB settings"></a>Configure GitLab DB settings</h3><pre><code># MySQL only:
sudo -u git cp config/database.yml.mysql config/database.yml

# MySQL and remote PostgreSQL only:
# Update username/password in config/database.yml.
# You only need to adapt the production settings (first part).
# If you followed the database guide then please do as follows:
# Change &apos;secure password&apos; with the value you have given to $password
# You can keep the double quotes around the password
sudo -u git -H editor config/database.yml
修改为正确的用户名和密码
分别修改git用户和root用户

# PostgreSQL and MySQL:
# Make config/database.yml readable to git only
sudo -u git -H chmod o-rwx config/database.yml
</code></pre><h3 id="Install-Gems"><a href="#Install-Gems" class="headerlink" title="Install Gems"></a>Install Gems</h3><p><strong>Note:</strong> As of bundler 1.5.2, you can invoke <code>bundle install -jN</code><br>(where <code>N</code> the number of your processor cores) and enjoy the parallel gems installation with measurable<br>difference in completion time (~60% faster). Check the number of your cores with <code>nproc</code>.<br>For more information check this <a href="http://robots.thoughtbot.com/parallel-gem-installing-using-bundler" target="_blank" rel="noopener">post</a>.<br>First make sure you have bundler &gt;= 1.5.2 (run <code>bundle -v</code>) as it addresses some <a href="https://devcenter.heroku.com/changelog-items/411" target="_blank" rel="noopener">issues</a><br>that were <a href="https://github.com/bundler/bundler/pull/2817" target="_blank" rel="noopener">fixed</a> in 1.5.2.</p>
<pre><code>cd /home/git/gitlab
</code></pre><p>修改为淘宝的ruby源</p>
<pre><code>vi Gemfile
</code></pre><p>修改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &quot;https://ruby.taobao.org/&quot;</span><br></pre></td></tr></table></figure>
<pre><code>sudo -u git -H bundle install --deployment --without development test postgres aws
</code></pre><p>这一步的时间会等很久</p>
<h3 id="Install-GitLab-shell"><a href="#Install-GitLab-shell" class="headerlink" title="Install GitLab shell"></a>Install GitLab shell</h3><p>GitLab Shell is an SSH access and repository management software developed specially for GitLab.</p>
<pre><code># Run the installation task for gitlab-shell (replace `REDIS_URL` if needed):
sudo -u git -H bundle exec rake gitlab:shell:install[v2.2.0] REDIS_URL=unix:/var/run/redis/redis.sock RAILS_ENV=production
</code></pre><p>执行上述命令如果有SSL证书问题，改用下述命令</p>
<pre><code>su - git
cd /home/git/gitlab
bundle exec rake gitlab:shell:install[v2.2.0] REDIS_URL=unix:/var/run/redis/redis.sock RAILS_ENV=production

logout
</code></pre><p>By default, the gitlab-shell config is generated from your main GitLab config. You can review (and modify) the gitlab-shell config as follows:</p>
<pre><code>sudo -u git -H editor /home/git/gitlab-shell/config.yml
</code></pre><p>Ensure the correct SELinux contexts are set. Read <a href="http://wiki.centos.org/HowTos/Network/SecuringSSH" target="_blank" rel="noopener">http://wiki.centos.org/HowTos/Network/SecuringSSH</a></p>
<pre><code>restorecon -Rv /home/git/.ssh
</code></pre><p><strong>Note:</strong> If you want to use HTTPS, see <a href="#using-https">Using HTTPS</a> for the additional steps.</p>
<h3 id="Initialize-Database-and-Activate-Advanced-Features"><a href="#Initialize-Database-and-Activate-Advanced-Features" class="headerlink" title="Initialize Database and Activate Advanced Features"></a>Initialize Database and Activate Advanced Features</h3><p>初始化数据库</p>
<pre><code>cd /home/git/gitlab/
sudo -u git -H bundle exec rake gitlab:setup RAILS_ENV=production
</code></pre><p>Type <strong>yes</strong> to create the database.<br>When done you see <strong>Administrator account created:</strong>.</p>
<p><strong>Note:</strong> You can set the Administrator password by supplying it in environmental variable <code>GITLAB_ROOT_PASSWORD</code>, eg.:</p>
<p>如果要修改gitlab管理员的密码，则执行这一句，否则执行上一句</p>
<pre><code>sudo -u git -H bundle exec rake gitlab:setup RAILS_ENV=production GITLAB_ROOT_PASSWORD=newpassword
</code></pre><h3 id="Install-Init-Script"><a href="#Install-Init-Script" class="headerlink" title="Install Init Script"></a>Install Init Script</h3><p>Download the init script (will be /etc/init.d/gitlab):</p>
<pre><code>sudo cp /home/git/gitlab/lib/support/init.d/gitlab /etc/init.d/gitlab

# wget -O /etc/init.d/gitlab https://gitlab.com/gitlab-org/gitlab-recipes/raw/master/init/sysvinit/centos/gitlab-unicorn --no-check-certificate
chmod +x /etc/init.d/gitlab
chkconfig --add gitlab
</code></pre><p>Make GitLab start on boot:</p>
<pre><code>chkconfig gitlab on
</code></pre><h3 id="Set-up-logrotate"><a href="#Set-up-logrotate" class="headerlink" title="Set up logrotate"></a>Set up logrotate</h3><pre><code>cp lib/support/logrotate/gitlab /etc/logrotate.d/gitlab
</code></pre><h3 id="Check-Application-Status"><a href="#Check-Application-Status" class="headerlink" title="Check Application Status"></a>Check Application Status</h3><p>Check if GitLab and its environment are configured correctly:</p>
<pre><code>sudo -u git -H bundle exec rake gitlab:env:info RAILS_ENV=production
</code></pre><h3 id="Compile-assets"><a href="#Compile-assets" class="headerlink" title="Compile assets"></a>Compile assets</h3><pre><code>sudo -u git -H bundle exec rake assets:precompile RAILS_ENV=production
</code></pre><h3 id="Start-your-GitLab-instance"><a href="#Start-your-GitLab-instance" class="headerlink" title="Start your GitLab instance"></a>Start your GitLab instance</h3><pre><code>service gitlab start
</code></pre><h2 id="7-Configure-the-web-server"><a href="#7-Configure-the-web-server" class="headerlink" title="7. Configure the web server"></a>7. Configure the web server</h2><p>Use either Nginx or Apache, not both. Official installation guide recommends nginx.</p>
<h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><p>You will need a new version of nginx otherwise you might encounter an issue like <a href="https://github.com/gitlabhq/gitlabhq/issues/5774" target="_blank" rel="noopener">this</a>.<br>To do so, follow the instructions provided by the <a href="http://wiki.nginx.org/Install#Official_Red_Hat.2FCentOS_packages" target="_blank" rel="noopener">nginx wiki</a> and then install nginx with:</p>
<pre><code>yum update
yum -y install nginx
chkconfig nginx on
</code></pre><p>使用SSl</p>
<pre><code>cp lib/support/nginx/gitlab-ssl /etc/nginx/conf.d/gitlab.conf
# wget -O /etc/nginx/conf.d/gitlab.conf https://gitlab.com/gitlab-org/gitlab-ce/raw/master/lib/support/nginx/gitlab-ssl --no-check-certificate
</code></pre><p>不使用SSL</p>
<pre><code>cp lib/support/nginx/gitlab /etc/nginx/conf.d/gitlab.conf

# wget -O /etc/nginx/conf.d/gitlab.conf https://gitlab.com/gitlab-org/gitlab-ce/raw/master/lib/support/nginx/gitlab --no-check-certificate
</code></pre><p>最后加上–no-check-certificate不检查证书</p>
<p>Edit <code>/etc/nginx/conf.d/gitlab.conf</code> and replace <code>git.example.com</code> with your FQDN. Make sure to read the comments in order to properly set up SSL.</p>
<pre><code>vi /etc/nginx/conf.d/gitlab.conf
去掉listen后面的default_server，修改为正确的端口号
去掉 listen [::]:
修改server_name 为本机的IP地址

修改client_max_body_size 256m;
否则当推送较多数据到 gitlab 上时，会由于数据过大，而出现错误
fatal: The remote end hung up unexpectedly fatal: The remote end hung up unexpectedly error: RPC failed; result=22, HTTP code = 413
</code></pre><p>Add <code>nginx</code> user to <code>git</code> group:</p>
<pre><code>usermod -a -G git nginx
chmod g+rx /home/git/


//chmod -R g+rx /home/git/gitlab/

# 修改权限
//chmod o+x /home/git
</code></pre><p>将selinux关闭，否则会出现 nginx 访问错误 (13: Permission denied)，HTTP显示502</p>
<pre><code>setenforce 0 # 只是临时关闭，重启后问题仍然出现
</code></pre><p>Finally start nginx with:</p>
<pre><code>service nginx start
</code></pre><p>出现错误<br>nginx: [emerg] bind() to 0.0.0.0:8080 failed (13: Permission denied)</p>
<p> <a href="http://www.tlanyan.me/nginx-open-failed-permission-denied/" target="_blank" rel="noopener">将selinux关闭就可以</a></p>
<p><strong>注意：开启selinux情况下正常使用nginx，需要修改selinux的策略</strong></p>
<p>将selinux关闭就可以</p>
<p>查看SELinux状态：<br>1、/usr/sbin/sestatus -v      ##如果SELinux status参数为enabled即为开启状态</p>
<pre><code>SELinux status:                 enabled
</code></pre><p>2、getenforce                 ##也可以用这个命令检查</p>
<p>关闭SELinux：<br>1、临时关闭（不用重启机器）：</p>
<pre><code>setenforce 0    ##设置SELinux 成为permissive模式
##setenforce 1 设置SELinux 成为enforcing模式
</code></pre><p>2、修改配置文件需要重启机器：<br>修改/etc/selinux/config 文件</p>
<pre><code>vi /etc/selinux/config
</code></pre><p>将<code>SELINUX=enforcing</code> 改为 <code>SELINUX=disabled</code>,重启机器即可</p>
<pre><code>shutdown -r now
service gitlab restart
</code></pre><h4 id="Test-Configuration"><a href="#Test-Configuration" class="headerlink" title="Test Configuration"></a>Test Configuration</h4><p>Validate your <code>gitlab</code> or <code>gitlab-ssl</code> Nginx config file with the following command:</p>
<pre><code>nginx -t
</code></pre><p>You should receive <code>syntax is okay</code> and <code>test is successful</code> messages. If you receive errors check your <code>gitlab</code> or <code>gitlab-ssl</code> Nginx config file for typos, etc. as indiciated in the error message given.</p>
<pre><code>//vi /home/git/gitlab-shell/config.yml
//修改gitlab_url为nginx中配置的相应端口
//gitlab_url: http://192.168.137.142:8083/
</code></pre><h2 id="8-Configure-the-firewall"><a href="#8-Configure-the-firewall" class="headerlink" title="8. Configure the firewall"></a>8. Configure the firewall</h2><p>Poke an iptables hole so users can access the web server (http and https ports) and ssh.</p>
<pre><code>lokkit -s http -s https -s ssh
</code></pre><p>添加防火墙允许的端口</p>
<pre><code>vi /etc/sysconfig/iptables
</code></pre><p>添加，端口为nginx中为gitlab设置的端口</p>
<pre><code>-A INPUT -m state --state NEW -m tcp -p tcp --dport 8083 -j ACCEPT
</code></pre><p>Restart the service for the changes to take effect:</p>
<pre><code>service iptables restart
</code></pre><h2 id="Done"><a href="#Done" class="headerlink" title="Done!"></a>Done!</h2><h3 id="Double-check-Application-Status"><a href="#Double-check-Application-Status" class="headerlink" title="Double-check Application Status"></a>Double-check Application Status</h3><p>To make sure you didn’t miss anything run a more thorough check with:</p>
<pre><code>cd /home/git/gitlab
sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production
</code></pre><p>Now, the output will complain that your init script is not up-to-date as follows:</p>
<pre><code>Init script up-to-date? ... no
  Try fixing it:
  Redownload the init script
  For more information see:
  doc/install/installation.md in section &quot;Install Init Script&quot;
  Please fix the error above and rerun the checks.
</code></pre><p>Do not mind about that error if you are sure that you have downloaded the up-to-date file from <a href="https://gitlab.com/gitlab-org/gitlab-recipes/raw/master/init/sysvinit/centos/gitlab-unicorn" target="_blank" rel="noopener">https://gitlab.com/gitlab-org/gitlab-recipes/raw/master/init/sysvinit/centos/gitlab-unicorn</a> and saved it to <code>/etc/init.d/gitlab</code>.</p>
<pre><code>wget https://gitlab.com/gitlab-org/gitlab-recipes/raw/master/init/sysvinit/centos/gitlab-unicorn
mv gitlab-unicorn gitlab
cp -f gitlab /etc/init.d/gitlab
rm gitlab
</code></pre><p>复制完后，要删除/etc/init.d/gitlab.swap文件</p>
<p>If all other items are green, then congratulations on successfully installing GitLab!</p>
<p><strong>NOTE:</strong> Supply <code>SANITIZE=true</code> environment variable to <code>gitlab:check</code> to omit project names from the output of the check command.</p>
<p>升级Gitlab Shell，安装的时候版本是2.1.0，需要升级到2.2.0才可以使用，否则会出现502错误</p>
<p>Upgrade GitLab Shell<br>GitLab Shell might be outdated, running the commands below ensures you’re using a compatible version:</p>
<pre><code>su - git
cd /home/git/gitlab-shell
git fetch
git checkout v`cat /home/git/gitlab/GITLAB_SHELL_VERSION`
</code></pre><p>One line upgrade command<br>You’ve read through the entire guide and probably already did all the steps one by one.</p>
<p>Here is a one line command with step 1 to 5 for the next time you upgrade:</p>
<pre><code>cd /home/git/gitlab; \
sudo -u git -H bundle exec rake gitlab:backup:create RAILS_ENV=production; \
sudo service gitlab stop; \
if [ -f bin/upgrade.rb ]; then sudo -u git -H ruby bin/upgrade.rb -y; else sudo -u git -H ruby script/upgrade.rb -y; fi; \
cd /home/git/gitlab-shell; \
sudo -u git -H git fetch; \
sudo -u git -H git checkout v`cat /home/git/gitlab/GITLAB_SHELL_VERSION`; \
cd /home/git/gitlab; \
exit; \
sudo service gitlab start; \
sudo service nginx restart; sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production
</code></pre><h2 id="Initial-Login"><a href="#Initial-Login" class="headerlink" title="Initial Login"></a>Initial Login</h2><p>Visit YOUR_SERVER in your web browser for your first GitLab login.<br>The setup has created an admin account for you. You can use it to log in:</p>
<pre><code>root
5iveL!fe
</code></pre><p><strong>Important Note:</strong><br>Please go over to your profile page and immediately change the password, so<br>nobody can access your GitLab by using this login information later on.</p>
<p><strong>Enjoy!</strong></p>
<p>You can also check some <a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/install/installation.md#advanced-setup-tips" target="_blank" rel="noopener">Advanced Setup Tips</a>.</p>
<h2 id="Links-used-in-this-guide"><a href="#Links-used-in-this-guide" class="headerlink" title="Links used in this guide"></a>Links used in this guide</h2><ul>
<li><a href="http://www.thegeekstuff.com/2012/06/enable-epel-repository/" target="_blank" rel="noopener">EPEL information</a></li>
<li><a href="http://wiki.centos.org/TipsAndTricks/SelinuxBooleans" target="_blank" rel="noopener">SELinux booleans</a></li>
</ul>
<h2 id="代码更新"><a href="#代码更新" class="headerlink" title="代码更新"></a>代码更新</h2><p><strong>修改Github上的代码，然后更新到服务器上</strong></p>
<pre><code>cd /home/git/gitlab/

git fetch origin
git merge origin/7-5-zh

重启 gitlab
service gitlab restart
</code></pre><h2 id="Gitlab-备份"><a href="#Gitlab-备份" class="headerlink" title="Gitlab 备份"></a>Gitlab 备份</h2><p>官网的备份说明</p>
<p><a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/raketasks/backup_restore.md" target="_blank" rel="noopener">https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/raketasks/backup_restore.md</a></p>
<h3 id="查看备份设置"><a href="#查看备份设置" class="headerlink" title="查看备份设置"></a>查看备份设置</h3><pre><code>vim /home/git/gitlab/config/gitlab.yml
</code></pre><p>检查Backup Settings设置项<br>默认情况下，备份文件是存放在/home/git/gitlab/tmp/backups/</p>
<h3 id="执行备份"><a href="#执行备份" class="headerlink" title="执行备份"></a>执行备份</h3><pre><code>sudo service gitlab stop # 先停止Gitlab，可以不暂停
cd /home/git/gitlab/
sudo -u git -H bundle exec rake gitlab:backup:create RAILS_ENV=production
</code></pre><p>执行完成后，会在/home/git/gitlab/tmp/backups/目录下创建一个备份俄文件，以时间戳_gitlab_backup命名如 1417040627_gitlab_backup.tar</p>
<h3 id="重新启动"><a href="#重新启动" class="headerlink" title="重新启动"></a>重新启动</h3><pre><code>sudo service gitlab start
sudo service nginx restart
</code></pre><h3 id="还原"><a href="#还原" class="headerlink" title="还原"></a>还原</h3><p>需要给其他用户配置读写执行的权限</p>
<pre><code>chmod o+wrx /home/git/.ssh/authorized_keys.lock
</code></pre><p>否则会出现如下错误，是由于没有权限<br>/home/git/gitlab-shell/lib/gitlab_keys.rb:101:in `initialize’: Permission denied @ rb_sysopen - /home/git/.ssh/authorized_keys.lock (Errno::EACCES)</p>
<p>需要使用 git 用户来执行，否则会没有权限操作 git 目录下的文件，<code>timestamp_of_backup</code>为时间戳如 1417040627</p>
<pre><code>sudo service gitlab stop
cd /home/git/gitlab/ 
sudo -u git -H bundle exec rake gitlab:backup:restore BACKUP=timestamp_of_backup RAILS_ENV=production
sudo service gitlab start
sudo service nginx restart
sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production
</code></pre><h3 id="设置自动备份"><a href="#设置自动备份" class="headerlink" title="设置自动备份"></a>设置自动备份</h3><pre><code>sudo service gitlab stop;
cd /home/git/gitlab;
sudo -u git -H editor config/gitlab.yml; # Enable keep_time in the backup section to automatically delete old backups
</code></pre><p>keep_time参数默认是604800（单位是秒），因此会保留最近7天内的备份</p>
<pre><code>sudo -u git crontab -e # Edit the crontab for the git user
</code></pre><p>将如下内容添加到文件末尾</p>
<pre><code># Create a full backup of the GitLab repositories and SQL database every day at 2am
0 2 * * * cd /home/git/gitlab &amp;&amp; PATH=/usr/local/bin:/usr/bin:/bin bundle exec rake gitlab:backup:create RAILS_ENV=production CRON=1
</code></pre><p>每天凌晨2点自动备份</p>
<p>The CRON=1 environment setting tells the backup script to suppress all progress output if there are no errors. This is recommended to reduce cron spam.</p>
<p><strong>重新启动</strong></p>
<pre><code>sudo service gitlab start;
sudo service nginx restart;
sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production;
</code></pre><h2 id="忘记管理员密码"><a href="#忘记管理员密码" class="headerlink" title="忘记管理员密码"></a>忘记管理员密码</h2><p>可以参考<a href="https://www.nitrohsu.com/gitlab-reset-administrator-password.html" target="_blank" rel="noopener">这篇文章</a></p>
<p>Gitlab 服务器上使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Gitlab 安装路径</span><br><span class="line">cd /home/git/gitlab</span><br><span class="line"># 进入Rails控制台</span><br><span class="line">sudo -u git -H bundle exec rails console production</span><br></pre></td></tr></table></figure>
<p>ominbus上使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-rails console</span><br><span class="line"># 或者</span><br><span class="line">sudo gitlab-rake rails console</span><br></pre></td></tr></table></figure>
<p>进入控制台，如果知道需要修改用户的邮箱，使用如下，直接修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user = User.find_by(email: &apos;admin@example.com&apos;)</span><br><span class="line">user.password = &apos;secret_password&apos;</span><br><span class="line">user.password_confirmation = &apos;secret_password&apos;</span><br><span class="line">user.save</span><br></pre></td></tr></table></figure>
<p>如果不知道具体邮箱，可以通过find来查找邮箱</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user = User.find(1)</span><br></pre></td></tr></table></figure>
</span>
      
    </div>

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Git/" rel="tag">#Git</a>
          
            <a href="/tags/Gitlab/" rel="tag">#Gitlab</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/04/09/centos-uwsgi-nginx-django/" rel="prev">CentOS 环境下基于 Nginx uwsgi 搭建 Django 站点</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/02/17/redis-practice/" rel="next">一次使用 Redis 优化查询性能的实践</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>
  


    <div class="post-spread">
      
    </div>
    
  </div>

 
        </div>

        
          
            <div class="comments" id="comments">
              
                <div id="disqus_thread">
                  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                </div>
              
            </div>
          
        
      </div>
      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/uploads/avatar.jpg" alt="restran" itemprop="image"/>
          <p class="site-author-name" itemprop="name">restran</p>
        </div>
        <p class="site-description motion-element" itemprop="description">在位流的海洋里徜徉～</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">64</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">17</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">64</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="menu-item-icon icon-next-feed"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/restran" target="_blank">Github</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/restran" target="_blank">Weibo</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://douban.com/people/restran" target="_blank">Douban</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/restran" target="_blank">Zhihu</a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
              <a href="http://blog.itpub.net/22664653/" target="_blank">北在南方</a>
              </span>
            
              <span class="links-of-author-item">
              <a href="http://qzcool.com/" target="_blank">fredliu</a>
              </span>
            
              <span class="links-of-author-item">
              <a href="http://linyuhao.cc/" target="_blank">依依呀呀</a>
              </span>
            
          
        </div>

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Overview"><span class="nav-number">1.</span> <span class="nav-text">Overview</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Important-Notes"><span class="nav-number">1.1.</span> <span class="nav-text">Important Notes</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#If-you-find-a-bug"><span class="nav-number">1.1.1.</span> <span class="nav-text">If you find a bug</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Security"><span class="nav-number">1.1.2.</span> <span class="nav-text">Security</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Installing-the-operating-system-CentOS-6-5-Minimal"><span class="nav-number">2.</span> <span class="nav-text">1. Installing the operating system (CentOS 6.5 Minimal)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Updating-and-adding-basic-software-and-services"><span class="nav-number">3.</span> <span class="nav-text">Updating and adding basic software and services</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Add-EPEL-repository"><span class="nav-number">3.1.</span> <span class="nav-text">Add EPEL repository</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Add-PUIAS-Computational-repository"><span class="nav-number">3.2.</span> <span class="nav-text">Add PUIAS Computational repository</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Install-the-required-tools-for-GitLab"><span class="nav-number">3.3.</span> <span class="nav-text">Install the required tools for GitLab</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Install-mail-server"><span class="nav-number">3.4.</span> <span class="nav-text">Install mail server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Configure-the-default-editor"><span class="nav-number">3.5.</span> <span class="nav-text">Configure the default editor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Install-Git-from-Source-optional"><span class="nav-number">3.6.</span> <span class="nav-text">Install Git from Source (optional)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Ruby"><span class="nav-number">4.</span> <span class="nav-text">2. Ruby</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-System-Users"><span class="nav-number">5.</span> <span class="nav-text">3. System Users</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Database"><span class="nav-number">6.</span> <span class="nav-text">4. Database</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-MySQL"><span class="nav-number">6.1.</span> <span class="nav-text">4.2 MySQL</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Redis"><span class="nav-number">7.</span> <span class="nav-text">5. Redis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-GitLab"><span class="nav-number">8.</span> <span class="nav-text">6. GitLab</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Clone-the-Source"><span class="nav-number">8.1.</span> <span class="nav-text">Clone the Source</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Configure-it"><span class="nav-number">8.2.</span> <span class="nav-text">Configure it</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Configure-GitLab-DB-settings"><span class="nav-number">8.3.</span> <span class="nav-text">Configure GitLab DB settings</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Install-Gems"><span class="nav-number">8.4.</span> <span class="nav-text">Install Gems</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Install-GitLab-shell"><span class="nav-number">8.5.</span> <span class="nav-text">Install GitLab shell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Initialize-Database-and-Activate-Advanced-Features"><span class="nav-number">8.6.</span> <span class="nav-text">Initialize Database and Activate Advanced Features</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Install-Init-Script"><span class="nav-number">8.7.</span> <span class="nav-text">Install Init Script</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Set-up-logrotate"><span class="nav-number">8.8.</span> <span class="nav-text">Set up logrotate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Check-Application-Status"><span class="nav-number">8.9.</span> <span class="nav-text">Check Application Status</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Compile-assets"><span class="nav-number">8.10.</span> <span class="nav-text">Compile assets</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Start-your-GitLab-instance"><span class="nav-number">8.11.</span> <span class="nav-text">Start your GitLab instance</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-Configure-the-web-server"><span class="nav-number">9.</span> <span class="nav-text">7. Configure the web server</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx"><span class="nav-number">9.1.</span> <span class="nav-text">Nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Test-Configuration"><span class="nav-number">9.1.1.</span> <span class="nav-text">Test Configuration</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-Configure-the-firewall"><span class="nav-number">10.</span> <span class="nav-text">8. Configure the firewall</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Done"><span class="nav-number">11.</span> <span class="nav-text">Done!</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Double-check-Application-Status"><span class="nav-number">11.1.</span> <span class="nav-text">Double-check Application Status</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Initial-Login"><span class="nav-number">12.</span> <span class="nav-text">Initial Login</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Links-used-in-this-guide"><span class="nav-number">13.</span> <span class="nav-text">Links used in this guide</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码更新"><span class="nav-number">14.</span> <span class="nav-text">代码更新</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Gitlab-备份"><span class="nav-number">15.</span> <span class="nav-text">Gitlab 备份</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查看备份设置"><span class="nav-number">15.1.</span> <span class="nav-text">查看备份设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行备份"><span class="nav-number">15.2.</span> <span class="nav-text">执行备份</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重新启动"><span class="nav-number">15.3.</span> <span class="nav-text">重新启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#还原"><span class="nav-number">15.4.</span> <span class="nav-text">还原</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置自动备份"><span class="nav-number">15.5.</span> <span class="nav-text">设置自动备份</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#忘记管理员密码"><span class="nav-number">16.</span> <span class="nav-text">忘记管理员密码</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


      
    </main>

    
    
    
        <footer id="footer" class="footer">
          <div class="footer-inner"> <div class="copyright" >
  
  &copy;&nbsp; 2014 - 
  <span itemprop="copyrightYear">2019</span>
  by
  <span class="author" itemprop="copyrightHolder">restran, </span>
</div>

  <span>thanks to <a class="theme-link" href="http://hexo.io">Hexo</a> and   
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT Mist. 
  </a>
  </span>

  <span>Hosted by <a href="https://pages.coding.me">Coding Pages</a></span>


 </div>
        </footer>
    
    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn",
        load: function (element_left) {
          // 图片加载后，修改 img 的父节点 a 的 href
          // 确保 fancybox 上面的图片显示正确
          var node = $(this);
          node.parent().attr('href', node.attr('data-original'));
        }
      });
    });
  </script>
  

  

  
  
<script type="text/javascript">
    (function() {
        var items = $('figure.highlight');
        for (var i = 0; i < items.length; i++) {
            var item = items[i];
            var node = $(item);
            var className = node.attr('class');
            var classList = className.split(' ');
            var langName = '';
            if (classList.length > 1) {
                langName = classList[1];
            }
            node.attr('data-lang', langName);
        };
    })();
</script>



  
  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>



  
    <script type="text/javascript">
  $(".reward-wrapper .reward-btn").fancybox({
      maxWidth: 650,
      maxHeight: 350,
      fitToView: true,
      autoSize: true,
      closeClick: false,
      openEffect: 'none',
      closeEffect: 'none',
      helpers: {
        title: {
            type: 'inside'
        },
        overlay: {
            locked: false
        }
      }
  });

  $("[data-track]").on("click", function() {
      var label = $(this).data("track");
      window._hmt && window._hmt.push(['_trackEvent', label, 'click']);
  });
</script>
  

  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>





  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.1" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" src="/js/post-detail.js"></script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>



  
    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
<script>AV.initialize("QnkkLfx3yvVKY4LTTTJBjDqW-gzGzoHsz", "FVfLCd14uEKbS1GXLxKWJS7O");</script>
<script type="text/javascript" src="/js/lean-analytics.js"></script>
  
  
  
    
  
    <script type="text/javascript">
      // 本地测试屏蔽评论
      var host = window.location.host;
      var disqus_shortname = host.includes('127.0.0.1') || host.includes('0.0.0.0') || host.includes('localhost') ? 'restranDev' : 'restran';
      // var disqus_shortname = 'restran';
      var disqus_identifier = '2015/04/09/gilab-centos-installation-note/';
      var disqus_title = 'CentOS 6.5 环境下 Gitlab 7.5 安装和维护笔记';
      var disqus_url = 'http://www.restran.net/2015/04/09/gilab-centos-installation-note/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  


  

  
</body>
</html>
